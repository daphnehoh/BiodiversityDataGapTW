---
title: "data_wrangling"
author: "Daphne Hoh"
date: "2024-06-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r env prep}
#setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
setwd("~/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/tmp/")

.packs <- c("httr", "jsonlite", "dplyr", "data.table", "stringr", 
            "ggplot2", "scales", "RColorBrewer", "tidyr", "tidyverse",
            "sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = T)

```

```{r load TBIA data}
# tbia <- fread("C:/Users/taibi/OneDrive/Desktop/Daphne/data/tbia_ver20240605.csv",
#               sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))

tbia <- fread("tmp/sample_n_100_taxaSubGroup_dQgood.csv",
              sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))

names(tbia)
head(tbia)

# remove unwanted columns
keep <- c("id", "rightsHolder", "datasetName", "basisOfRecord",
          "year", "month",
          "latitude", "longitude", "coordinatePrecision", "coordinateUncertaintyInMeters", "type",
          "taxonID", "taxonRank", "taxaSubGroup",
          "kingdom", "phylum", "class", "order", "family", "genus", "scientificName")

tbia <- tbia %>%
  select(all_of(keep))
```


```{r prep: the manual cleaning} 
# (1) remove data without scientificName
tbia <- tbia[!is.na(tbia$scientificName),]

# (1.1) add a simple_scientificName column to extract species name without infraspecies for some stats
tbia$simple_scientificName <- str_extract(tbia$scientificName, "^\\w+ \\w+") 


# formatting: change to numeric
tbia[, c("longitude", "latitude", "coordinatePrecision", "coordinateUncertaintyInMeters")] <- 
  lapply(tbia[, c("longitude", "latitude", "coordinatePrecision", "coordinateUncertaintyInMeters")], as.numeric)

# (2) coordinateUncertaintyInMeters (extract numbers)
table(tbia$coordinateUncertaintyInMeters)
tbia$coordinateUncertaintyInMeters <- as.numeric(gsub("[^0-9.]", "", tbia$coordinateUncertaintyInMeters))
```


```{r load TaiCOL data to combine with TBIA table}
# download full TaiCOL list at https://taicol.tw/static/upload/TaiCOL_taxon_20240528.zip

keep <- c("rank","taxon_id","simple_name","common_name_c",
          "is_endemic","alien_type","is_terrestrial","is_freshwater","is_brackish","is_marine","is_in_taiwan",
          "kingdom","kingdom_c","phylum","phylum_c","class","class_c","order","order_c","family","family_c","genus","genus_c")
          
df.taicol.list <- fread("../www/data/TaiCOL_taxon_20240528.csv", select = keep,
                        sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))

df.taicol.list <- df.taicol.list %>% 
  filter(is_in_taiwan == "true") # 94,684

# add a simple_scientificName column to extract species name without infraspecies for some stats
df.taicol.list$simple_scientificName <- str_extract(df.taicol.list$simple_name, "^\\w+ \\w+") 

# use same column name
names(df.taicol.list)
names(df.taicol.list)[1] <- "taxonRank"
names(df.taicol.list)[2] <- "taxonID"
```

```{r prep: make taxaSubGroup in TaiCOL list}
# add a new column categorizing them into my defined taxaSubGroup
# make taxaSubGroup in df.taicol.list
`%ni%` <- Negate(`%in%`)

taxa <- df.taicol.list

taxa$micro <- fifelse(taxa$simple_name %in% c("Bacteria", "Archaea", "Protozoa", "Chromista"), paste0(taxa$simple_name), "x")
taxa$micro.k <- fifelse(taxa$kingdom %in% c("Bacteria", "Archaea", "Protozoa", "Chromista"), paste0(taxa$kingdom), "x")

taxa$virus <- fifelse(taxa$kingdom %in% c("Orthornavirae", "Bamfordvirae", "Heunggongvirae", "Pararnavirae", 
                                          "Ribozyviria kingdom incertae sedis", "Shotokuvirae", "Viruses kingdom incertae sedis"), "Viruses", "x")

taxa <- taxa %>%
  mutate(fungi = case_when(simple_name == "Fungi" ~ "Other fungi",
                           kingdom == "Fungi" & phylum %ni% c("Ascomycota", "Basidiomycota") ~ "Other fungi",
                           phylum == "Ascomycota" ~ "Ascomycota",
                           phylum == "Basidiomycota" ~ "Ascomycota",
                           TRUE ~ "x"))

taxa <- taxa %>%
  mutate(plant.tmp = case_when(simple_name == "Plantae" ~ "Other plants",
                               kingdom == "Plantae" & is.na(phylum) ~ "Other plants",
                               kingdom == "Plantae" & phylum %in% c("Charophyta", "Chlorophyta", "Rhodophyta") ~ "Algae",
                               kingdom == "Plantae" & phylum %in% c("Anthocerotophyta", "Bryophyta", "Marchantiophyta") ~ "Mossess",
                               kingdom == "Plantae" & class %in% c("Polypodiopsida", "Lycopodiopsida") ~ "Ferns",
                               kingdom == "Plantae" & class == "Magnoliopsida" ~ "Angiosperms",
                               kingdom == "Plantae" & class %in% c("Cycadopsida", "Ginkgoopsida", "Pinopsida") ~ "Gymnosperms",
                               TRUE ~ "x"))
taxa$plant <- fifelse(taxa$kingdom == "Plantae" & taxa$plant.tmp == "x", "Other plants", paste0(taxa$plant.tmp))          

taxa <- taxa %>%
  mutate(animal.tmp = case_when(simple_name == "Animalia" ~ "Other animals",
                                kingdom == "Animalia" & phylum == "Chordata" & class %in% 
                                  c("Chondrichthyes", "Actinopterygii", "Actinopteri", "Elasmobranchii", "Holocephali", "Myxini") ~ "Fishes",
                                kingdom == "Animalia" & phylum == "Chordata" & class == "Aves" ~ "Birds",
                                kingdom == "Animalia" & phylum == "Chordata" & class == "Amphibia" ~ "Amphibians",
                                kingdom == "Animalia" & phylum == "Chordata" & class == "Reptilia" ~ "Reptiles",
                                kingdom == "Animalia" & phylum == "Chordata" & class == "Mammalia" ~ "Mammals",
                                kingdom == "Animalia" & phylum == "Chordata" & class == "NA" ~ "Other chordates",
                                kingdom == "Animalia" & class == "Insecta" & order == "Coleoptera" ~ "Coleoptera",
                                kingdom == "Animalia" & class == "Insecta" & order == "Lepidoptera" ~ "Lepidoptera",
                                kingdom == "Animalia" & class == "Insecta" & order %ni% c("Coleoptera", "Lepidoptera") ~ "Other insects",
                                kingdom == "Animalia" & phylum == "Arthropoda" & class == "Insecta" & is.na(order) ~ "Other insects",
                                kingdom == "Animalia" & phylum == "Arthropoda" & class == "Arachnida" ~ "Arachnida",
                                kingdom == "Animalia" & phylum == "Arthropoda" & class == "Malacostraca" ~ "Malacostraca",
                                kingdom == "Animalia" & phylum == "Arthropoda" & class %ni% c("Insecta" ,"Arachnida", "Malacostraca") ~ "Other arthropods",
                                kingdom == "Animalia" & phylum == "Arthropoda" & is.na(class) ~ "Other arthropods",
                                kingdom == "Animalia" & phylum == "Mollusca" & class == "Bivalvia" ~ "Bivalves",
                                kingdom == "Animalia" & phylum == "Mollusca" & class == "Gastropoda" ~ "Gastropods",
                                kingdom == "Animalia" & phylum == "Mollusca" & class == "Cephalopoda" ~ "Cephalopods",
                                kingdom == "Animalia" & phylum == "Mollusca" & class %ni% c("Bivalvia", "Gastropoda", "Cephalopoda") ~ "Other molluscs",
                                kingdom == "Animalia" & phylum == "Mollusca" & is.na(class) ~ "Other molluscs",
                                kingdom == "Animalia" & phylum == "Cnidaria" ~ "Cnidarians",
                                kingdom == "Animalia" & phylum == "Echinodermata" ~ "Echinoderms",
                                kingdom == "Animalia" & is.na(phylum) ~ "Other animals",
                                TRUE ~ "x"))
taxa$animal <- fifelse(taxa$kingdom == "Animalia" & taxa$animal.tmp == "x", "Other animals", paste0(taxa$animal.tmp))                                     

# combine and make taxaSubGroup
taxa1 <- taxa %>%
  mutate_all(~ifelse(. == 'x', NA, .)) %>%
  unite(taxaSubGroup, micro, micro.k, virus, fungi, plant, animal, sep = ",", remove = T, na.rm = T) %>%
  select(-c(plant.tmp, animal.tmp, is_in_taiwan))

# those with incomplete taxa levels so the categorizing failed
table(taxa1$taxaSubGroup) # 21 empty
taxa1 <- taxa1 %>% 
  mutate(taxaSubGroup = replace(taxaSubGroup, taxaSubGroup %in% "", "Unclassified"))

```

```{r prep: TaiCOL habitats}
## keep habitats to 'yes' only for easier filtering (i.e. make 'false' as NA)
taxa2 <- taxa1 %>% 
  mutate(is_terrestrial = replace(is_terrestrial, is_terrestrial == "false", NA)) %>% 
  mutate(is_freshwater = replace(is_freshwater, is_freshwater == "false", NA)) %>% 
  mutate(is_brackish = replace(is_brackish, is_brackish == "false", NA)) %>% 
  mutate(is_marine = replace(is_marine, is_marine == "false", NA))

# final TaiCOL table that classified with taxaSubGroup
fwrite(taxa2, "../www/data/TaiCOL_taxon_20240528_taxaSubGroup.csv",
       row.names = F, quote = T)
```

```{r prep: add habitat info to TBIA table}
habitat <- select(taxa2, taxonID, is_terrestrial, is_freshwater, is_brackish, is_marine)
tbia1 <- left_join(tbia, habitat, by = "taxonID")

fwrite(tbia1, "../www/data/tbia_habitat.csv",
       row.names = F, quote = T)
```



```{r load updated TBIA & TaiCOL table}
tbia <- fread("../www/data/tbia_habitat.csv", 
              sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))

taicol <- fread("../www/data/TaiCOL_taxon_20240528_taxaSubGroup.csv", 
              sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
```


```{r prep for Section: Taxonomic - data wrangling}
# Subsection: Taxonomic Gap
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")

# (1)
## % record matched to highest taxon rank
df_taxa.rank <- data.frame(table(tbia$taxonRank))
names(df_taxa.rank) <- c("rank", "count")

### grouping the subs together
df_taxa.rank$taxonRank <- fifelse(df_taxa.rank$rank %in% species_infraspecies,
                                  "(infra)species", 
                                  paste0(df_taxa.rank$rank))

fwrite(df_taxa.rank, "../www/data/df_taxa.rank.csv", 
       row.names = F, quote = T)  


# (2)
## % record species rank matched to TaiCOL
df_taxa.rank.at.species <- tbia %>%
  filter(taxonRank %in% species_infraspecies) %>%
  summarise(count = n_distinct(simple_scientificName)) %>%
  mutate(proportion = count / 64542 * 100) %>% # TaiCOL last stats 20240610
  bind_rows(data.frame(count = 64542 - .$count, proportion = 100 - .$proportion)) %>%
  mutate(category = c("Recorded", "Unrecorded"))

fwrite(df_taxa.rank.at.species, "../www/data/df_taxa.rank.at.species.csv", 
       row.names = F, quote = T)


# (3)
## The XX% of the unrecorded TaiCOL taxa on TBIA
### get total number of species (un)recorded in TBIA
df_taxa.unrecorded.taxa.prop <- tbia %>%
  filter(taxonRank %in% species_infraspecies) %>%
  distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% # to remove infraspecies count
  group_by(taxaSubGroup) %>%
  summarise(record.count = n())




### separate them by habitats
#### replace 'true' string in each habitat to its' respective column name
habitats <- c("is_terrestrial", "is_freshwater", "is_brackish", "is_marine")

for (col in habitats) {
  for (i in 1:nrow(tbia)) {
    if (!is.na(tbia[[col]][i]) && tbia[[col]][i] == "true") {
      tbia[[col]][i] <- col
    }
  }  
}

df_taxa.unrecorded.taxa.prop.habitats <- list()

df_taxa.unrecorded.taxa.prop.habitats <- map(habitats, ~{
  tbia %>%
    filter(taxonRank %in% species_infraspecies) %>%
    distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% 
    group_by(taxaSubGroup, .data[[.x]]) %>%
    summarise(record.count = n())
})

for (df in seq_along(df_taxa.unrecorded.taxa.prop.habitats)) { # rename column name is_* to habitat
  df_taxa.unrecorded.taxa.prop.habitats[[df]] <- rename(df_taxa.unrecorded.taxa.prop.habitats[[df]], habitat = 2)
}

group.habitats.tbia <- do.call(rbind, df_taxa.unrecorded.taxa.prop.habitats)




df <- taicol

# Function for processing habitats and counts
process_habitats <- function(df, habitats) {
  
  # replace 'true' as column name of habitat "is_*"
  for (col in habitats) {
    for (i in 1:nrow(df)) {
      if (!is.na(df[[col]][i]) && df[[col]][i] == "true") {
        df[[col]][i] <- col
      }
    }
  }  
  
  # summarise count by habitat
  df_taxa.unrecorded.taxa.prop.habitats <- map(habitats, ~{
    df %>%
      filter(taxonRank %in% species_infraspecies) %>%
      distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% 
      group_by(taxaSubGroup, .data[[.x]]) %>%
      summarise(record.count = n())
  })
  
  # rename column name of each habitat "is_*" to "habitat" for easy grouping
  for (i in seq_along(df_taxa.unrecorded.taxa.prop.habitats)) { 
    df_taxa.unrecorded.taxa.prop.habitats[[i]] <- rename(df_taxa.unrecorded.taxa.prop.habitats[[i]], habitat = 2)
  }
  
  group.habitats.df <- do.call(rbind, df_taxa.unrecorded.taxa.prop.habitats)
  
  return(group.habitats.df)
}

# Usage
processed_data <- process_habitats(taicol, habitats)










#-------------------------------
### Select: Habitat = All
group.all <- taicol %>%
  filter(rank %in% str_to_title(species_infraspecies)) %>%
  # get distinct simple_scientificName because need to remove infraspecies count
  distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% 
  group_by(taxaSubGroup) %>%
  summarise(taicol.count = n())

sum(group.all$taicol.count) # 63,800 species level

### combine counts of TBIA + TaiCOL above
df_taxa.unrecorded.taxa.prop.groupAll <- left_join(group.all, df_taxa.unrecorded.taxa.prop, by = "taxaSubGroup")

df_taxa.unrecorded.taxa.prop.groupAll <-  df_taxa.unrecorded.taxa.prop.groupAll %>%
  rowwise() %>%
  mutate(record.prop = round(record.count / taicol.count * 100, 2),
         taicol.prop = round(100 - record.prop, 2)) #%>%
  # ungroup() %>%
  # filter(!grepl("Other ", taxaSubGroup) & taxaSubGroup != "Unclassified") # remove "Other x" from df

fwrite(df_taxa.unrecorded.taxa.prop.groupAll, "../www/data/df_taxa.unrecorded.taxa.prop.groupAll.csv", 
       row.names = F, quote = T)

 
### Select: Habitat = either of the is_*
habitats <- c("is_terrestrial", "is_freshwater", "is_brackish", "is_marine")
group.habitat <- list()

group.habitat <- map(habitats, ~{
  taicol %>%
    filter(rank %in% str_to_title(species_infraspecies)) %>%
    # get distinct simple_scientificName because need to remove infraspecies count
    distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% 
    group_by(taxaSubGroup, .data[[.x]]) %>%  # Use !! to unquote the variable
    summarise(taicol.count = n()) %>%
    rowwise() %>%
    mutate(record.prop = round(record.count / taicol.count * 100, 2),
           taicol.prop = round(100 - record.prop, 2))
})

group.habitats <- bind_rows(group.habitat, .id = "habitat")

#### Combine the all + habitats into single table






# Subsection: Species Tree
```


```{r prep for Section: Temporal}


```



```{r prep for Section: Spatial}
# subset from main table
spatial_df <- tbia[, c("id", "longitude", "latitude", "coordinatePrecision", "coordinateUncertaintyInMeters", "type", "taxaSubGroup")]

# exclude coordinateUncertaintyInMeters > 5000 meter
spatial_df <- spatial_df[spatial_df$coordinateUncertaintyInMeters <= 5000,]

# for geometry
spatial_coords_sf <- st_as_sf(spatial_df, coords = c("longitude", "latitude"), crs = 4326)

## want points in grid, not occ record

leaflet() %>%
      addTiles() %>%
      setView(lng = 120, lat = 21, zoom = 7) %>%
      addResetMapButton() %>%
      addPolygons(
        data = spatial_coords_sf,
        fillColor = ~pal(nmbr_f_),
        weight = 1,
        opacity = 1,
        color = 'white',
        fillOpacity = 0.5,
        popup = ~paste("Number of records:", nmbr_f_)) %>%
      addLegend(
        data = occ.grid5km_sf,
        pal = pal,
        values = ~nmbr_f_,
        opacity = 0.5,
        title = "Record count",
        position = "bottomright")



```







