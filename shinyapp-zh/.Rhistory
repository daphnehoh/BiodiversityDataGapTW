runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
install.packages("rsconnect")
library(rsconnect)
rsconnect::setAccountInfo(name='daphnehoh', token='848D939E1EE76DA9DFCFC69114757652', secret='WsR2B3TLUEyzQcOCgZgyOzeIZOGGAKayDDjnomr9')
deployApp()
deployApp()
deployApp()
leaflet() %>% addProviderTiles(providers$Esri)
leaflet() %>% addProviderTiles(providers$Esri.WorldGrayCanvas)
update.packages()
library(leaflet)
library(leaflet.providers)
# Create a Leaflet map centered around a specific location
m <- leaflet() %>%
setView(lng = -73.9851, lat = 40.7589, zoom = 13) %>%
addProviderTiles(providers$OpenStreetMap)
# Display the map
m
rsconnect::deployApp()
rsconnect::deployApp()
runApp()
rsconnect::deployApp()
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("www/data/raw/tbia_ver20240605.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/01.raw_data/ver5_ver20240605/tbia_ver20240605.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
# remove unwanted columns
keep <- c("id", "rightsHolder", "datasetName", "basisOfRecord",
"year", "month",
"latitude", "longitude", "coordinatePrecision", "coordinateUncertaintyInMeters",
"taxonID", "taxonRank", "taxaSubGroup",
"kingdom", "phylum", "class", "order", "family", "genus", "scientificName")
rm(m, occ.grid5km_sf, gapCountdf, df_map, df_taxa_map)
tbia <- tbia %>%
select(all_of(keep))
gc()
rm(tbia, keepp)
rm(tbia, keep)
gc()
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605/tbia_vtaxa.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia_vtaxa.csv"
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia_vtaxa.csv"
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia_vtaxa.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
names(tbia)
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia5_vtaxa.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
names(tbia)
head(tbia)
# remove unwanted columns
keep <- c("id", "year", "month",
"latitude", "longitude", "coordinatePrecision", "coordinateUncertaintyInMeters",
"taxonID", "taxonRank", "taxaSubGroup",
"kingdom", "phylum", "class", "order", "family", "genus", "scientificName")
tbia <- tbia %>%
select(all_of(keep))
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
taxa2 <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
head(taxa2)
habitat <- select(taxa2, taxonID, is_terrestrial, is_freshwater, is_brackish, is_marine)
tbia1 <- left_join(tbia, habitat, by = "taxonID")
fwrite(tbia1, "www/data/processed/tbia_habitat.csv",
row.names = F, quote = T)
head(tbia1)
table(tbia1$is_brackish)
table(tbia1$is_marine)
gc()
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
taicol <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
df_taxa.rank <- data.frame(table(tbia$taxonRank))
names(df_taxa.rank) <- c("rank", "count")
### grouping the subs together
df_taxa.rank$taxonRank <- fifelse(df_taxa.rank$rank %in% species_infraspecies,
"(infra)species",
paste0(df_taxa.rank$rank))
df_taxa.rank
fwrite(df_taxa.rank, "www/data/processed/df_taxa.rank.csv",
row.names = F, quote = T)
shiny::runApp()
plot_ly(df_taxa.rank, labels = ~taxonRank, values = ~count, type = "pie", sort = F,
hoverinfo = "label+value", textinfo = "percent", marker = list(colors = tbia.color_6)) %>%
config(displayModeBar = FALSE)
# TBIA colour theme
tbia.color_6 <- c("#3E5145", "#76A678", "#E5C851", "#E2A45F", "#F8E3C4", "#C75454")
plot_ly(df_taxa.rank.at.species, labels = ~category, values = ~count, type = "pie", sort = F,
hoverinfo = "label+value", textinfo = "percent", marker = list(colors = tbia.color_6)) %>%
config(displayModeBar = FALSE)
df_taxa.rank.at.species <- fread("www/data/processed/df_taxa.rank.at.species.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
df_taxa.rank.at.species <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
summarise(count = n_distinct(simple_scientificName)) %>%
mutate(proportion = count / 64542 * 100) %>% # TaiCOL last stats 20240610
bind_rows(data.frame(count = 64542 - .$count, proportion = 100 - .$proportion)) %>%
mutate(category = c("Recorded", "Unrecorded"))
head(tbia)
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia5_vtaxa.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
names(tbia)
head(tbia)
# remove unwanted columns
keep <- c("id", "year", "month",
"latitude", "longitude", "coordinatePrecision", "coordinateUncertaintyInMeters",
"taxonID", "taxonRank", "taxaSubGroup",
"kingdom", "phylum", "class", "order", "family", "genus", "scientificName", "simple_scientificName")
tbia <- tbia %>%
select(all_of(keep))
df_taxa.rank.at.species <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
summarise(count = n_distinct(simple_scientificName)) %>%
mutate(proportion = count / 64542 * 100) %>% # TaiCOL last stats 20240610
bind_rows(data.frame(count = 64542 - .$count, proportion = 100 - .$proportion)) %>%
mutate(category = c("Recorded", "Unrecorded"))
fwrite(df_taxa.rank.at.species, "www/data/processed/df_taxa.rank.at.species.csv",
row.names = F, quote = T)
df_taxa.rank.at.species
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
group.all <- taicol %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>%
group_by(taxaSubGroup) %>%
summarise(taicol.count = n())
sum(group.all$taicol.count)
df_taxa.unrecorded.taxa.prop <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% # to remove infraspecies count
group_by(taxaSubGroup) %>%
summarise(record.count = n())
### combine counts of TBIA + TaiCOL above
df_taxa.unrecorded.taxa.prop.groupAll <- left_join(group.all, df_taxa.unrecorded.taxa.prop, by = "taxaSubGroup")
df_taxa.unrecorded.taxa.prop.groupAll <-  df_taxa.unrecorded.taxa.prop.groupAll %>%
rowwise() %>%
mutate(record.prop = round(record.count / taicol.count * 100, 2),
taicol.prop = round(100 - record.prop, 2)) %>%
ungroup() %>%
filter(taxaSubGroup != "Unclassified") %>%
mutate_all(~replace_na(., 0)) %>%
mutate(cum.total = taicol.count - record.count)
df_taxa.unrecorded.taxa.prop.groupAll
View(df_taxa.unrecorded.taxa.prop.groupAll)
fwrite(df_taxa.unrecorded.taxa.prop.groupAll, "www/data/processed/df_taxa.unrecorded.taxa.prop.groupAll.csv",
row.names = F, quote = T)
### Select habitat: separate them by habitats
#### function for processing habitats and counts
process_habitats <- function(df) {
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
habitats <- c("is_terrestrial", "is_freshwater", "is_brackish", "is_marine")
# summarise count by habitat
df_taxa.unrecorded.taxa.prop.habitats <- map(habitats, ~{
df %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% # not counting infraspecies
group_by(taxaSubGroup, .data[[.x]]) %>% # group and count separately for each habitat
summarise(record.count = n())
})
# rename column name of each habitat "is_*" to "habitat" for easy grouping
for (i in seq_along(df_taxa.unrecorded.taxa.prop.habitats)) {
df_taxa.unrecorded.taxa.prop.habitats[[i]] <- rename(df_taxa.unrecorded.taxa.prop.habitats[[i]], habitat = 2)
}
group.habitats.df <- do.call(rbind, df_taxa.unrecorded.taxa.prop.habitats) %>%
filter(!is.na(habitat) & habitat != "false") # excluding NA and false count
return(group.habitats.df)
}
#### apply summarize function
taicol_habitat_count <- process_habitats(taicol)
tbia_habitat_count <- process_habitats(tbia)
taicol_habitat_count
tbia_habitat_count
names(taicol)
names(tbia)
tbia1
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
tbia
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
taicol <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
taicol_habitat_count <- process_habitats(taicol)
tbia_habitat_count <- process_habitats(tbia)
tbia
gc()
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("C:/Users/taibi/Documents/GitHub/TBIA-data-review/02.processed_data/ver5_ver20240605_shiny/tbia5_vtaxa.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
names(tbia)
head(tbia)
# remove unwanted columns
keep <- c("id", "year", "month",
"latitude", "longitude", "coordinatePrecision", "coordinateUncertaintyInMeters",
"taxonID", "taxonRank", "taxaSubGroup",
"kingdom", "phylum", "class", "order", "family", "genus", "scientificName", "simple_scientificName")
tbia <- tbia %>%
select(all_of(keep))
taxa2 <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
habitat <- select(taxa2, taxonID, is_terrestrial, is_freshwater, is_brackish, is_marine)
tbia1 <- left_join(tbia, habitat, by = "taxonID")
fwrite(tbia1, "www/data/processed/tbia_habitat.csv",
row.names = F, quote = T)
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
taicol <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
names(tbia)
names(taicol)
gc()
gc()
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
taicol <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
# (1)
## % record matched to highest taxon rank
df_taxa.rank <- data.frame(table(tbia$taxonRank))
names(df_taxa.rank) <- c("rank", "count")
### grouping the subs together
df_taxa.rank$taxonRank <- fifelse(df_taxa.rank$rank %in% species_infraspecies,
"(infra)species",
paste0(df_taxa.rank$rank))
fwrite(df_taxa.rank, "www/data/processed/df_taxa.rank.csv",
row.names = F, quote = T)
# (2)
## % record (infra)species rank matched to TaiCOL
df_taxa.rank.at.species <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
summarise(count = n_distinct(simple_scientificName)) %>%
mutate(proportion = count / 64542 * 100) %>% # TaiCOL last stats 20240610
bind_rows(data.frame(count = 64542 - .$count, proportion = 100 - .$proportion)) %>%
mutate(category = c("Recorded", "Unrecorded"))
fwrite(df_taxa.rank.at.species, "www/data/processed/df_taxa.rank.at.species.csv",
row.names = F, quote = T)
# (3)
## The XX% of the unrecorded TaiCOL taxa on TBIA
### Select habitat: All
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
group.all <- taicol %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>%
group_by(taxaSubGroup) %>%
summarise(taicol.count = n())
sum(group.all$taicol.count) # 63,800 species level
### get total number of species (un)recorded in TBIA
df_taxa.unrecorded.taxa.prop <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% # to remove infraspecies count
group_by(taxaSubGroup) %>%
summarise(record.count = n())
### combine counts of TBIA + TaiCOL above
df_taxa.unrecorded.taxa.prop.groupAll <- left_join(group.all, df_taxa.unrecorded.taxa.prop, by = "taxaSubGroup")
df_taxa.unrecorded.taxa.prop.groupAll <-  df_taxa.unrecorded.taxa.prop.groupAll %>%
rowwise() %>%
mutate(record.prop = round(record.count / taicol.count * 100, 2),
taicol.prop = round(100 - record.prop, 2)) %>%
ungroup() %>%
filter(taxaSubGroup != "Unclassified") %>%
mutate_all(~replace_na(., 0)) %>%
mutate(cum.total = taicol.count - record.count)
#filter(!grepl("Other ", taxaSubGroup) & taxaSubGroup != "Unclassified") # remove "Other x" from df
fwrite(df_taxa.unrecorded.taxa.prop.groupAll, "www/data/processed/df_taxa.unrecorded.taxa.prop.groupAll.csv",
row.names = F, quote = T)
### Select habitat: separate them by habitats
#### function for processing habitats and counts
process_habitats <- function(df) {
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
habitats <- c("is_terrestrial", "is_freshwater", "is_brackish", "is_marine")
# summarise count by habitat
df_taxa.unrecorded.taxa.prop.habitats <- map(habitats, ~{
df %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>% # not counting infraspecies
group_by(taxaSubGroup, .data[[.x]]) %>% # group and count separately for each habitat
summarise(record.count = n())
})
# rename column name of each habitat "is_*" to "habitat" for easy grouping
for (i in seq_along(df_taxa.unrecorded.taxa.prop.habitats)) {
df_taxa.unrecorded.taxa.prop.habitats[[i]] <- rename(df_taxa.unrecorded.taxa.prop.habitats[[i]], habitat = 2)
}
group.habitats.df <- do.call(rbind, df_taxa.unrecorded.taxa.prop.habitats) %>%
filter(!is.na(habitat) & habitat != "false") # excluding NA and false count
return(group.habitats.df)
}
taicol_habitat_count <- process_habitats(taicol)
tbia_habitat_count <- process_habitats(tbia)
#### combine the counts
names(taicol_habitat_count)[3] <- "taicol.count"
tbia_habitat_count
taicol_habitat_count
df_counts_by_habitats <- left_join(taicol_habitat_count, tbia_habitat_count, by = c("taxaSubGroup", "habitat")) %>%
filter(taxaSubGroup != "Unclassified") %>%
mutate_all(~replace_na(., 0)) %>%
mutate(cum.total = taicol.count - record.count)
df_counts_by_habitats
fwrite(df_counts_by_habitats, "www/data/processed/df_counts_by_habitats.csv",
row.names = F, quote = T)
taicol_species <- taicol %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>%
select(taxonID, taxaSubGroup, family, genus, simple_scientificName) %>%
filter(if_all(everything(), ~ !grepl("incertae sedis", ., ignore.case = TRUE))) # remove rows containing 'incertae sedis'
tbia_recorded_species <- tbia %>%
filter(taxonRank %in% species_infraspecies) %>%
distinct(taxaSubGroup, simple_scientificName, .keep_all = TRUE) %>%
select(taxonID)
taicol_species$tbia.recorded <- ifelse(taicol_species$taxonID %in% tbia_recorded_species$taxonID, TRUE, FALSE)
table(taicol_species$tbia.recorded)
taicol_species$recorded <- fifelse(taicol_species$tbia.recorded == TRUE,
paste0("[Recorded] ", taicol_species$simple_scientificName), taicol_species$simple_scientificName)
fwrite(taicol_species, "www/data/processed/df_tree.csv",
row.names = F, quote = T)
df_time <- tbia[, c("id", "year", "month", "taxaSubGroup")]
fwrite(df_time, "www/data/processed/df_time.csv",
row.names = F, quote = T)
grid5km_sf <- st_read("tmp/layers/TW_WGS84_land&ocean_grids/0_05degree_tw_landocean_grid.shp")
# load the tbia table
df_map <- tbia[, c("id", "longitude", "latitude", "coordinatePrecision", "coordinateUncertaintyInMeters", "taxaSubGroup")]
## 1. exclude uncertainty in distance
table(df_map$coordinatePrecision)
table(df_map$coordinateUncertaintyInMeters)
df_map <- df_map[df_map$coordinateUncertaintyInMeters <= 5000,] # exclude > 5km (5000 meter) for 5km grid plotting
## 2. map All records to grid
df_map_stats <- df_map %>%
group_by(taxaSubGroup, latitude, longitude) %>%
count()
df_map_list <- split(df_map_stats, df_map_stats$taxaSubGroup)
catchLocation <- function(x){
x %>%
st_as_sf(coords = c("longitude", "latitude"), remove = FALSE) %>% # set coordinates
st_set_crs(4326) %>%  # table transform to polygon
st_join(., dg_grid, join = st_intersects, left = TRUE, largest = TRUE) %>%
st_drop_geometry(.)
}
#### parallel ####
cpu.cores <- detectCores() - 8
cl <- makeCluster(cpu.cores)
#### parallel ####
cpu.cores <- detectCores() - 8
cpu.cores
cl <- makeCluster(cpu.cores)
df_map_list
cl <- makeCluster(cpu.cores)
cl
cl <- makeCluster(cpu.cores)
makeCluster(cpu.cores)
makeCluster
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
taicol <- fread("www/data/processed/TaiCOL_taxon_20240528_taxaSubGroup.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
species_infraspecies <- c("species", "subspecies", "variety", "subvariety", "form", "subform", "special form")
grid5km_sf <- st_read("tmp/layers/TW_WGS84_land&ocean_grids/0_05degree_tw_landocean_grid.shp")
# load the tbia table
df_map <- tbia[, c("id", "longitude", "latitude", "coordinatePrecision", "coordinateUncertaintyInMeters", "taxaSubGroup")]
## 1. exclude uncertainty in distance
table(df_map$coordinatePrecision)
table(df_map$coordinateUncertaintyInMeters)
df_map <- df_map[df_map$coordinateUncertaintyInMeters <= 5000,] # exclude > 5km (5000 meter) for 5km grid plotting
## 2. map All records to grid
df_map_stats <- df_map %>%
group_by(taxaSubGroup, latitude, longitude) %>%
count()
df_map_list <- split(df_map_stats, df_map_stats$taxaSubGroup)
grid5km_sf
catchLocation <- function(x){
x %>%
st_as_sf(coords = c("longitude", "latitude"), remove = FALSE) %>% # set coordinates
st_set_crs(4326) %>%  # table transform to polygon
st_join(., dg_grid, join = st_intersects, left = TRUE, largest = TRUE) %>%
st_drop_geometry(.)
}
#### parallel ####
cpu.cores <- detectCores() - 8
cl <- makeCluster(cpu.cores)
cl
clusterEvalQ(cl, { # make sure all clusters are ready
library(tidyverse)
library(data.table)
library(sf)
library(lwgeom)
dg_grid <- st_read("tmp/layers/TW_WGS84_land&ocean_grids/0_05degree_tw_landocean_grid.shp")
dg_grid <- as(dg_grid, "sf")%>%
st_set_crs(4326)
sf_use_s2(F)
}
)
system.time(
df_map_grid <- parLapply(cl, df_map_list, catchLocation)%>%
do.call(rbind,.))
stopCluster(cl)
### 3 make all records table
allOccCount_grid_table <- df_map_grid %>%
group_by(taxaSubGroup) %>%
summarise(allOccCount = sum(n))
allOccCount_grid_table
fwrite(allOccCount_grid_table, "www/data/processed/df_spatial_allOccCount_grid_table.csv",
row.names = F, quote = T)
### 4 make All records shp
allOccCount <- df_map_grid %>%
group_by(id) %>%
summarise(occCount = sum(n))
allOccCount
### 4.1 combine grid counts with 5km geometry
allOccCount_grid <- merge(allOccCount, grid5km_sf, by = "id", all.x = TRUE)
st_write(allOccCount_grid, "www/data/processed/df_map.shp")
allOccCount_grid
### 5 make taxaSubGroup
taxaOccCount <- df_map_grid %>%
group_by(taxaSubGroup, id) %>%
summarise(occCount = sum(n))
taxaOccCount
### 5.1 combine grid counts with 5km geometry
taxaOccCount_grid <- merge(taxaOccCount, grid5km_sf, by = "id", all.x = TRUE)
names(taxaOccCount_grid) <- c("id", "tSG", "occCount", "geometry") # rename because ESRI cannot save long field name
st_write(taxaOccCount_grid, "www/data/processed/df_taxa_map.shp", append = TRUE)
taxaOccCount_grid
df_gapCount <- st_read("www/data/processed/df_map.shp")
df_gapCount <- df_gapCount %>%
mutate(priority = case_when(occCount < 10 ~ "Priority",
occCount >= 10 & occCount < 20 ~ "Intermediate",
occCount > 20 ~ "Non-priority"))
st_write(df_gapCount, "www/data/processed/df_gapCount_table.shp",
row.names = F, quote = T)
# save as table
df_gapCount_table <- as.data.frame(df_gapCount) %>%
group_by(priority) %>%
summarise(gridCount = sum(occCount))
fwrite(df_gapCount_table, "www/data/processed/df_gapCount_table.csv",
row.names = F, quote = T)
gc()
shiny::runApp()
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp/BiodiversityDataGapTW-shinyapp/")
setwd("C:/Users/taibi/Documents/GitHub/BiodiversityDataGapTW/shinyapp-zh/")
.packs <- c("httr", "jsonlite", "data.table",
"dplyr", "stringr", "tidyverse",
"sf", "parallel", "lwgeom")
sapply(.packs, require, character.only = TRUE)
tbia <- fread("www/data/processed/tbia_habitat.csv",
sep = ",", colClasses = "character", encoding = "UTF-8", na.strings = c("", "NA", "N/A"))
table(tbia$year)
table(tbia$year) %>% View()
26+3+31+97
shiny::runApp()
runApp()
runApp()
occ.grid5km_sf <- st_read("www/data/layers/5km/to_grid5km.shp")
occ.grid5km_sf <- st_read("www/data/layers/5km/0_05degree_tw_landocean_grid.shp")
runApp()
runApp()
shiny::runApp()
